<html>
  <head>
    <script src="http://ease-62q56ueo.cloudapp.net/libs/ease.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script>
      var messagesScroll;
      var initialLoad = true;

      $(document).ready(function() {
        //var ease = new Ease("hi@example.com", "app", "buXOEAfmXmRwJHafvSFCpnXkNjZElH");
        var ease = new Ease("hi@example.com", "testapp", "OZgSHtEozKjHCXZRpyuAOhfcSNiwHM");

        ease.baseUrl = '162.243.87.146:3001';
        //ease.baseUrl = 'localhost:3001';

        // For messing around in the console.
        window.ease = ease;

        messagesScroll = $('#messagelist');

        refreshMessages(ease);

        setInterval(function() {
          refreshMessages(ease);
        }, 200);

        $("#chatform").submit(function(evt) {
          console.log("Form submitted...")
          evt.preventDefault();
          var inputText = $("#chatinput").val();
          $("#chatinput").val("");
          ease.read("/messages", function(err, messages) {
            if (err) {
              console.log("Error reading messages.");
              return;
            }
            if (messages == null) {
              messages = [];
            }
            messages.push(inputText);
            ease.save("/messages", messages, function(err) {
              if (err) {
                console.log("Error communicating with server.");
                return;
              }
              refreshMessages(ease);
            });
          });
          return false;
        })
      });

      var messageCount, currentScroll, maxScrollHeight = 0;
      function refreshMessages(ease) {
        console.log("Refreshing messages...");
        var messageList = $("#messagelist");
        ease.read("/messages", function(err, messages) {
          if (err || messages == null) {
            return;
          }
          if (messageCount == messages.length) {
            return;
          }

          currentScroll = messagesScroll.scrollTop();
          maxScrollHeight = messagesScroll[0].scrollHeight;

          messageCount = messages.length;
          messageList.empty();
          console.log("Messages: " + messages);
          for (var i = 0; i < messages.length; i++) {
            messageList.append("<li>" + messages[i] + "</li>");
          }

          if (initialLoad) {
            messagesScroll.scrollTop(messagesScroll.prop("scrollHeight"));
            initialLoad = false;
            return;
          }

          if (currentScroll > (maxScrollHeight - 400)) {
            messagesScroll.scrollTop(messagesScroll.prop("scrollHeight"));
          }

        });
      }
    </script>

    <style>
      body {
        text-align: center;
      }
      #messagelist {
        overflow: auto;
        height: 200px;
        width: 90%;
        list-style-type: none;
        text-align: center;
        padding-left: 0px;
        margin: 10px auto;
      }
      #messagelist li {
        margin-bottom: 2px;
        background-color: #ddd;
      }
    </style>

  </head>
  <body>
    <h1>Chat Demo!</h1>
    <h2>Messages</h2>
    <ul id="messagelist">
    </ul>
    <form id="chatform">
      <input type="text" id="chatinput">
      <input type="submit" value="Send message!">
    </form>
  </body>
</html>
